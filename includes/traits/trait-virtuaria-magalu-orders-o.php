<?php
defined("\101\102\123\120\x41\124\110") || die; trait Virtuaria_Magalu_Orders_Trait { private function create_order($sell) { $order = wc_create_order(); if (isset($sell["\103\x75\x73\x74\x6f\x6d\145\x72\120\146\116\x61\155\145"])) { $name = explode("\x20", $sell["\x43\165\163\x74\157\x6d\x65\162\x50\146\116\141\x6d\x65"]); } else { $name = explode("\x20", $sell["\x43\165\x73\164\x6f\155\x65\162\x50\152\x43\157\162\160\157\162\x61\164\x65\156\141\x6d\145"]); } $first_name = array_shift($name); $address = array("\x66\151\162\163\x74\137\x6e\x61\155\x65" => $first_name ? $first_name : implode("\40", $name), "\154\141\163\164\137\156\141\x6d\145" => $first_name ? implode("\40", $name) : '', "\x65\155\x61\x69\154" => $sell["\x43\x75\x73\164\x6f\155\x65\162\x4d\141\x69\154"], "\x70\x68\x6f\156\x65" => isset($sell["\x54\x65\x6c\145\160\150\157\x6e\x65\115\141\x69\x6e\x4e\x75\x6d\x62\x65\162"]) ? $sell["\124\x65\154\145\160\x68\x6f\x6e\145\x4d\x61\x69\x6e\116\x75\x6d\142\x65\x72"] : $sell["\124\x65\154\145\160\x68\x6f\x6e\145\x42\x75\163\151\x6e\145\163\x73\116\165\x6d\142\145\x72"], "\141\x64\144\x72\145\163\163\137\61" => $sell["\104\x65\154\x69\x76\145\162\x79\101\144\144\x72\145\x73\x73\123\x74\x72\145\x65\x74"], "\141\144\144\162\145\x73\x73\137\62" => $sell["\104\x65\x6c\x69\166\145\162\x79\101\x64\x64\162\x65\163\163\101\x64\144\x69\x74\151\157\x6e\141\x6c\111\x6e\146\157"], "\x63\151\164\x79" => $sell["\104\x65\x6c\151\166\145\162\171\101\x64\x64\x72\145\x73\x73\x43\x69\164\171"], "\163\x74\141\x74\145" => $sell["\x44\x65\x6c\151\x76\145\x72\171\x41\144\144\x72\x65\163\x73\x53\164\141\164\x65"], "\160\x6f\163\164\x63\157\x64\x65" => $sell["\104\x65\x6c\151\x76\x65\162\x79\x41\144\144\x72\x65\x73\x73\x5a\x69\x70\143\x6f\x64\x65"], "\x63\157\165\x6e\x74\162\x79" => "\x42\x52"); $order->set_address($address); $order->set_address($address, "\163\x68\x69\x70\160\151\156\x67"); $order->update_meta_data("\137\142\151\x6c\154\151\x6e\x67\x5f\143\x70\x66", isset($sell["\x43\165\x73\x74\157\155\x65\x72\x50\x66\103\x70\x66"]) ? $sell["\103\165\x73\x74\157\x6d\x65\x72\x50\146\103\160\146"] : $sell["\103\165\x73\x74\x6f\x6d\145\162\x50\x6a\103\x6e\160\152"]); $order->update_meta_data("\137\142\151\154\x6c\151\x6e\x67\137\x6e\x65\x69\x67\x68\x62\157\x72\150\157\157\144", $sell["\104\145\154\x69\x76\x65\x72\171\101\144\144\x72\145\163\163\x4e\145\x69\147\150\142\x6f\162\x68\157\x6f\144"]); $order->update_meta_data("\137\x73\150\151\160\x70\151\156\x67\137\x6e\145\x69\x67\x68\x62\x6f\x72\x68\157\x6f\144", $sell["\x44\x65\x6c\151\166\145\x72\171\x41\x64\144\162\x65\163\163\116\145\x69\x67\x68\x62\157\x72\150\157\x6f\x64"]); $order->update_meta_data("\137\x62\151\x6c\154\151\156\x67\x5f\x6e\x75\155\x62\x65\162", $sell["\x44\145\154\151\166\145\x72\171\101\x64\144\162\145\x73\x73\116\165\155\142\145\x72"]); $order->update_meta_data("\137\x73\150\x69\160\160\151\156\147\x5f\x6e\165\155\x62\145\x72", $sell["\x44\x65\x6c\151\x76\x65\162\x79\x41\144\144\x72\x65\163\x73\116\x75\155\142\145\162"]); $has_problem = false; foreach ($sell["\120\162\157\144\x75\143\164\163"] as $item) { $product_id = wc_get_product_id_by_sku($item["\111\x64\x53\153\x75"]); if ($product_id) { $product = wc_get_product($product_id); if ($product->get_stock_quantity() >= $item["\121\165\141\x6e\x74\x69\164\171"]) { $order->add_product($product, $item["\x51\165\141\156\x74\151\x74\x79"], array("\163\165\142\164\157\164\141\154" => $this->convert_to_float($item["\120\162\x69\x63\x65"]), "\164\157\x74\x61\154" => $this->convert_to_float($item["\120\x72\151\x63\x65"]) * $item["\x51\x75\x61\x6e\x74\151\x74\171"])); } else { $this->log->add($this->tag, "\117\40\160\162\x6f\144\x75\164\x6f\x20\144\x65\x20\163\x6b\x75\40" . $item["\x49\x64\x53\153\165"] . "\40\160\x6f\163\x73\x75\x69\40\145\x73\x74\x6f\x71\165\x65\x20\151\156\x73\x75\x66\x69\x63\x69\145\x6e\164\x65\40\160\x61\162\141\x20\x69\155\160\x6f\162\x74\x61\x72\40\x61\40\x76\x65\x6e\144\x61\56", WC_Log_Levels::ERROR); wp_mail(get_option("\x61\144\x6d\x69\x6e\x5f\145\155\x61\151\154"), "\x5b" . get_bloginfo("\x6e\x61\155\x65") . "\135\x20\x2d\40\106\141\154\x68\141\40\x61\157\40\x69\x6d\160\157\x72\164\141\x20\160\x65\x64\151\x64\x6f", "\x44\145\x76\151\144\x6f\40\x61\157\x20\x65\163\164\157\x71\165\x65\40\x69\156\x73\x75\x66\151\x63\x69\x65\156\164\x65\x20\144\x6f\40\160\x72\157\144\165\x74\x6f\40" . $item["\x49\144\x53\153\165"] . "\54\x20\x6e\xc3\243\x6f\40\146\157\x69\x20\160\x6f\163\x73\xc3\255\x76\145\154\40\x69\x6d\x70\x6f\162\164\141\162\x20\x6f\40\x70\145\x64\x69\x64\157\x20\x23" . $item["\x49\x64\x4f\x72\144\145\x72"] . "\x2e"); $has_problem = true; break; } } else { $this->log->add($this->tag, "\x46\141\x6c\150\141\40\141\x6f\x20\x6c\x6f\x63\x61\x6c\151\x7a\141\x72\40\157\40\160\x72\x6f\144\165\x74\157\x20\144\145\40\163\153\x75\x20" . $item["\111\144\x53\153\165"], WC_Log_Levels::ERROR); wp_mail(get_option("\141\x64\x6d\151\156\x5f\x65\x6d\141\x69\154"), "\133" . get_bloginfo("\156\x61\x6d\145") . "\135\40\x2d\x20\x46\x61\154\150\141\40\x61\157\40\x69\155\x70\x6f\162\164\x61\40\160\145\x64\x69\x64\157", "\104\x65\166\151\144\x6f\40\141\x20\x66\x61\x6c\x68\x61\x20\x61\x6f\40\x6c\x6f\x63\141\x6c\x69\x7a\x61\162\x20\x6f\40\160\162\x6f\144\165\164\x6f\40" . $item["\111\x64\123\153\165"] . "\54\x20\156\303\xa3\157\x20\x66\157\151\40\x70\x6f\163\x73\xc3\xad\166\145\x6c\x20\x69\x6d\160\x6f\162\164\x61\162\40\x6f\40\x70\x65\144\151\x64\157\x20\x23" . $item["\111\x64\x4f\162\x64\x65\x72"] . "\x2e"); $has_problem = true; break; } } if ($has_problem) { $order->delete(true); return; } $order->add_shipping(new WC_Shipping_Rate("\146\154\x61\x74\137\162\141\164\x65\x5f\155\141\147\x61\154\165", "\105\156\164\162\x65\x67\x65\x20\166\x69\x61\40\115\x61\x67\x61\154\x75", $this->convert_to_float($sell["\124\x6f\x74\x61\154\x46\162\x65\x69\x67\150\164"]), array(), "\x66\154\141\164\x5f\162\141\164\x65")); if (floatval($sell["\124\x6f\x74\141\154\x44\151\x73\x63\157\165\x6e\x74"]) > 0) { $discount = new WC_Order_Item_Fee(); $discount->set_name("\104\145\x73\143\157\x6e\164\x6f\163"); $discount->set_total(-$this->convert_to_float($sell["\x54\157\164\x61\x6c\104\151\163\x63\157\x75\x6e\164"])); $order->add_item($discount); } if (floatval($sell["\x54\157\x74\141\154\x54\141\170"]) > 0) { $tax = new WC_Order_Item_Fee(); $tax->set_name("\111\x6d\160\157\x73\164\157\163"); $tax->set_total($this->convert_to_float($sell["\124\x6f\164\x61\154\x54\141\x78"])); $order->add_item($tax); } $order->calculate_totals(); $order->update_meta_data("\x5f\155\141\147\141\x6c\x75\137\x6f\x72\144\145\x72\x5f\151\144", $sell["\111\144\x4f\x72\x64\x65\162"]); $order->add_order_note(sprintf("\x3c\142\76\x4d\x61\x67\141\154\165\74\57\x62\x3e\74\142\162\x3e\x4e\303\272\155\145\x72\x6f\40\144\x6f\x20\160\x65\144\x69\144\x6f\x3a\x20\x25\x31\x24\x73\74\142\x72\76\x4c\x6f\152\x61\72\x20\x25\x32\x24\163\x3c\142\162\76\120\x61\x67\141\x6d\x65\x6e\x74\x6f\72\x20\x25\x33\44\x73\x3c\x62\x72\76\120\x61\x72\143\x65\154\141\x73\x3a\x20\x25\x34\44\x73\74\x62\162\x3e\120\162\x61\172\x6f\40\160\162\141\x20\160\x6f\163\164\141\147\145\x6d\x3a\x20\45\65\x24\x73", $sell["\x49\x64\117\162\144\x65\x72"], $sell["\x4d\141\162\153\x65\x74\160\154\x61\x63\x65\x4e\x61\x6d\145"], isset($sell["\x50\141\171\155\x65\156\164\x73"][0]["\x4e\141\155\145"]) ? $sell["\x50\141\171\155\145\x6e\164\x73"][0]["\x4e\141\155\x65"] : "\x4e\xc3\243\x6f\x20\x69\x64\x65\156\x74\x69\146\x69\143\141\144\x6f", isset($sell["\120\141\171\155\x65\x6e\164\163"][0]["\x49\156\163\164\141\154\x6c\155\x65\156\x74\x73"]) ? $sell["\120\x61\x79\x6d\145\156\164\163"][0]["\x49\x6e\163\164\x61\154\x6c\x6d\145\156\164\163"] : "\116\303\xa3\157\40\151\144\x65\156\x74\151\x66\x69\x63\x61\x64\157", isset($sell["\160\157\163\x74\x69\x6e\147\114\151\155\151\x74"]) ? $sell["\x70\157\163\164\x69\x6e\147\114\151\155\x69\x74"] : "\x4e\303\xa3\157\40\x69\x6e\146\157\x72\155\x61\x64\157")); $order->set_status("\167\x63\x2d\x70\x72\x6f\x63\145\163\x73\151\156\x67"); $payment_method = "\x4d\141\147\141\x7a\151\x6e\x65\x20\114\x75\151\x7a\141"; $order->set_payment_method($payment_method); $order->set_payment_method_title($payment_method); $order->set_created_via($payment_method); $order->set_date_created($sell["\101\160\x70\162\x6f\x76\x65\144\x44\141\x74\145"]); return $order->save(); } }
